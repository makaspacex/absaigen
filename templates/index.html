<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>å¹¿æ’­ç”µè§†å’Œç½‘ç»œè§†å¬æ™ºèƒ½åª’ä½“å†…å®¹ç”Ÿæˆç³»ç»Ÿ</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue",
                   Arial, "Noto Sans", "PingFang SC", "Microsoft YaHei", sans-serif;
      color: #e5e7eb;
      background:
        radial-gradient(circle at top left,#0b1120 0,#020617 45%,#000 100%),
        linear-gradient(135deg,rgba(56,189,248,0.08),transparent 60%);
      background-attachment: fixed;
    }

    /* èƒŒæ™¯ç½‘æ ¼ */
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background-image:
        linear-gradient(rgba(15,23,42,0.7) 1px, transparent 1px),
        linear-gradient(90deg, rgba(15,23,42,0.7) 1px, transparent 1px);
      background-size: 32px 32px;
      opacity: 0.18;
      pointer-events: none;
      z-index: -1;
    }

    .neon-card {
      background: radial-gradient(circle at top left,rgba(15,23,42,0.96),rgba(15,23,42,0.92));
      border-radius: 14px;
      border: 1px solid rgba(56,189,248,0.35);
      box-shadow:
        0 0 24px rgba(56,189,248,0.25),
        0 0 1px rgba(15,23,42,0.9);
      backdrop-filter: blur(16px);
    }

    .app-header {
      padding: 12px 26px;
      border-bottom: 1px solid rgba(148,163,184,0.35);
      background:
        radial-gradient(circle at top left,rgba(56,189,248,0.16),transparent 55%),
        linear-gradient(to right,rgba(15,23,42,0.96),rgba(15,23,42,0.4));
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 10px 24px rgba(15,23,42,0.7);
      position: relative;
      z-index: 2;
    }

    .app-title-block {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .app-title-main {
      font-size: 22px;
      font-weight: 600;
      letter-spacing: 0.04em;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .app-title-main::before {
      content: "";
      width: 14px;
      height: 14px;
      border-radius: 999px;
      background: radial-gradient(circle,#22d3ee 0,#0ea5e9 50%,transparent 100%);
      box-shadow: 0 0 18px rgba(34,211,238,0.9);
    }

    .app-header-right {
      display: flex;
      align-items: center;
      gap: 16px;
      font-size: 12px;
      color: #9ca3af;
    }

    .header-pill {
      padding: 4px 12px;
      border-radius: 999px;
      border: 1px solid rgba(56,189,248,0.6);
      background:
        radial-gradient(circle at 20% 0,rgba(34,211,238,0.25),transparent 70%),
        rgba(15,23,42,0.9);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .header-pill-dot {
      width: 9px;
      height: 9px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 10px rgba(34,197,94,0.9);
    }

    .user-pill {
      padding: 4px 12px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.7);
      background: radial-gradient(circle at 0 0,rgba(148,163,184,0.25),transparent 65%);
      display: inline-flex;
      align-items: center;
      gap: 7px;
    }

    .user-avatar {
      width: 20px;
      height: 20px;
      border-radius: 999px;
      background: radial-gradient(circle,#38bdf8,#0ea5e9);
      box-shadow: 0 0 10px rgba(56,189,248,0.7);
    }

    .app-container {
      display: flex;
      height: calc(100vh - 62px);
    }

    /* ä¾§è¾¹æ  */
    .sidebar {
      width: 210px;
      border-right: 1px solid rgba(30,64,175,0.9);
      background:
        radial-gradient(circle at top,#020617 0,#020617 45%,#020617 100%),
        linear-gradient(to bottom,rgba(15,23,42,0.95),rgba(15,23,42,0.98));
      position: relative;
      box-shadow: 10px 0 24px rgba(15,23,42,0.9);
      z-index: 1;
    }

    .sidebar-header {
      padding: 10px 20px 4px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      color: #64748b;
    }

    .nav-item {
      padding: 11px 24px 11px 30px;
      cursor: pointer;
      font-size: 14px;
      color: #e5e7eb;
      position: relative;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all .18s ease-out;
    }

    .nav-item-icon {
      width: 16px;
      text-align: center;
      font-size: 14px;
      opacity: .9;
    }

    .nav-item::before {
      content: "";
      position: absolute;
      left: 12px;
      top: 50%;
      width: 3px;
      height: 3px;
      border-radius: 999px;
      background: #64748b;
      transform: translateY(-50%);
      transition: all .2s;
    }

    .nav-item.active {
      color: #e0f2fe;
      font-weight: 600;
      padding-left: 34px;
      background: linear-gradient(to right,rgba(15,23,42,0.98),rgba(15,23,42,0.8));
      box-shadow: inset 3px 0 0 rgba(56,189,248,0.9);
    }

    .nav-item.active::before {
      width: 4px;
      height: 20px;
      border-radius: 999px;
      background: linear-gradient(to bottom,#22d3ee,#0ea5e9);
      box-shadow: 0 0 12px rgba(56,189,248,0.9);
      left: 8px;
    }

    .nav-item:hover:not(.active) {
      background: rgba(15,23,42,0.85);
      color: #e5e7eb;
    }

    .nav-item-library {
      margin-top: 14px;
      padding-top: 16px;
      border-top: 1px solid rgba(30,64,175,0.9);
      opacity: .98;
      font-size: 14px;
    }

    .main {
      flex: 1;
      padding: 18px 22px 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      overflow: auto;
    }

    .main-top {
      display: grid;
      grid-template-columns: minmax(0,2.3fr) minmax(0,1.2fr);
      grid-gap: 16px;
      min-height: 260px;
    }

    /* é¢„è§ˆåŒºåŸŸ */
    .preview-panel {
      padding: 14px;
      position: relative;
      overflow: hidden;
    }

    .preview-panel-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 8px;
      font-size: 13px;
      color: #9ca3af;
    }

    .preview-title {
      font-weight: 600;
      color: #e5e7eb;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .preview-title::after {
      content: "å®æ—¶é¢„è§ˆ";
      font-size: 10px;
      padding: 1px 6px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.7);
      color: #9ca3af;
    }

    .preview-panel-inner {
      margin-top: 4px;
      border-radius: 12px;
      border: 1px solid rgba(148,163,184,0.6);
      padding: 12px;
      height: calc(100% - 26px);
      background-image:
        radial-gradient(circle at top left,rgba(56,189,248,0.12),transparent 55%),
        linear-gradient(135deg,rgba(15,23,42,0.96),rgba(15,23,42,0.98));
      position: relative;
      overflow: hidden;
    }

    .preview-panel-inner::before {
      content: "";
      position: absolute;
      inset: -1px;
      border-radius: 13px;
      border: 1px solid rgba(56,189,248,0.4);
      opacity: 0.25;
      pointer-events: none;
    }

    .preview-grid {
      width: 100%;
      height: 100%;
      border-radius: 10px;
      border: 1px dashed rgba(148,163,184,0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
      background: radial-gradient(circle at center,rgba(15,23,42,0.9),rgba(15,23,42,1));
    }

    .preview-grid::after {
      content: "";
      position: absolute;
      width: 140%;
      height: 140%;
      background-image:
        radial-gradient(circle at 0 0,rgba(56,189,248,0.16),transparent 60%),
        radial-gradient(circle at 100% 100%,rgba(56,189,248,0.16),transparent 60%);
      opacity: 0.5;
      pointer-events: none;
    }

    .preview-placeholder {
      position: relative;
      z-index: 1;
      text-align: center;
      color: #9ca3af;
      font-size: 13px;
    }

    .preview-placeholder-title {
      font-size: 15px;
      margin-bottom: 6px;
      color: #e5e7eb;
    }

    .loading-box {
      position: relative;
      z-index: 1;
      text-align: center;
      display: none;
      font-size: 13px;
      color: #9ca3af;
    }

    .spinner {
      width: 44px;
      height: 44px;
      border-radius: 999px;
      border: 3px solid rgba(148,163,184,0.35);
      border-top-color: #22d3ee;
      margin: 0 auto 10px;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      from { transform: rotate(0); }
      to   { transform: rotate(360deg); }
    }

    #imageResult {
      max-width: 100%;
      max-height: 100%;
      border-radius: 10px;
      display: none;
      z-index: 1;
      position: relative;
      box-shadow: 0 18px 34px rgba(0,0,0,0.7);
    }

    #audioPreview, #videoPreview {
      position: relative;
      z-index: 1;
      display: none;
      text-align: center;
    }

    #audioPlayer, #videoPlayer {
      width: 82%;
      max-width: 720px;
    }

    #videoPlayer {
      max-height: 360px;
      border-radius: 10px;
      border: 1px solid rgba(148,163,184,0.8);
      box-shadow: 0 18px 34px rgba(0,0,0,0.7);
    }

    .panel-tag {
      font-size: 11px;
      padding: 3px 10px;
      border-radius: 999px;
      border: 1px solid rgba(56,189,248,0.6);
      color: #a5f3fc;
      background:
        radial-gradient(circle at 0 0,rgba(34,211,238,0.2),transparent 60%),
        rgba(15,23,42,0.92);
    }

    .control-panel {
      padding: 14px;
    }

    .control-fields {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .field {
      padding: 10px 12px;
      font-size: 13px;
    }

    .field-label {
      font-weight: 600;
      margin-bottom: 6px;
      display: inline-block;
      color: #e5e7eb;
    }

    .radio-group {
      display: flex;
      flex-wrap: wrap;
      gap: 8px 18px;
      margin-top: 4px;
    }

    .radio-group label {
      cursor: pointer;
      color: #cbd5f5;
      font-size: 13px;
    }

    .radio-group input {
      margin-right: 4px;
    }

    .dropdown {
      width: 100%;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid rgba(148,163,184,0.8);
      background: rgba(15,23,42,0.96);
      color: #e5e7eb;
      outline: none;
      font-size: 13px;
      box-shadow: 0 0 0 1px rgba(15,23,42,0.9);
    }

    textarea {
      width: 100%;
      border: none;
      resize: vertical;
      min-height: 70px;
      outline: none;
      background: rgba(15,23,42,0.8);
      border-radius: 8px;
      padding: 8px;
      color: #e5e7eb;
      font-size: 13px;
      border: 1px solid rgba(51,65,85,0.9);
    }

    textarea::placeholder {
      color: #6b7280;
    }

    .generate-panel {
      margin-top: 10px;
      display: flex;
      align-items: center;
      justify-content: flex-end;
    }

    .btn-generate {
      min-width: 130px;
      padding: 10px 20px;
      border-radius: 999px;
      border: 1px solid rgba(56,189,248,0.7);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      background:
        radial-gradient(circle at 20% 0,#22d3ee,#0f766e 60%,#020617 100%);
      color: #ecfeff;
      box-shadow: 0 0 20px rgba(56,189,248,0.7);
      transition: transform .15s ease-out, box-shadow .15s ease-out, opacity .15s;
    }

    .btn-generate:hover:not(:disabled) {
      transform: translateY(-1px) scale(1.01);
      box-shadow: 0 0 30px rgba(56,189,248,0.95);
    }

    .btn-generate:active:not(:disabled) {
      transform: translateY(1px) scale(.98);
      box-shadow: 0 0 18px rgba(56,189,248,0.7);
    }

    .btn-generate:disabled {
      opacity: .6;
      cursor: default;
      box-shadow: none;
    }

    /* ç”Ÿæˆå†…å®¹åº“é¡µé¢ */
    .library-panel {
      margin-top: 4px;
      padding: 12px 14px 14px;
      font-size: 13px;
    }

    .library-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .library-title {
      font-weight: 600;
      color: #e5e7eb;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .library-title-dot {
      width: 9px;
      height: 9px;
      border-radius: 999px;
      background: #22d3ee;
      box-shadow: 0 0 10px rgba(34,211,238,0.9);
    }

    .library-subtitle {
      font-size: 11px;
      color: #9ca3af;
    }

    .library-filters {
      display: inline-flex;
      gap: 6px;
      align-items: center;
    }

    .filter-pill {
      padding: 3px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.6);
      cursor: pointer;
      font-size: 12px;
      color: #cbd5f5;
      background: rgba(15,23,42,0.9);
      transition: all .15s;
    }

    .filter-pill.active {
      border-color: rgba(56,189,248,0.8);
      background:
        radial-gradient(circle at 0 0,rgba(34,211,238,0.2),transparent 60%),
        rgba(15,23,42,0.98);
      color: #a5f3fc;
      box-shadow: 0 0 12px rgba(56,189,248,0.6);
    }

    .library-stats {
      font-size: 11px;
      color: #9ca3af;
      margin-top: 2px;
    }

    .library-list {
      margin-top: 6px;
      max-height: calc(100vh - 170px);
      overflow-y: auto;
      padding-right: 4px;
    }

    .library-empty {
      color: #6b7280;
      font-size: 12px;
      padding: 6px 2px;
    }

    .library-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 7px 8px;
      border-radius: 8px;
      border: 1px solid rgba(15,23,42,0.9);
      cursor: pointer;
      transition: all .15s;
      margin-bottom: 4px;
      background: radial-gradient(circle at top left,rgba(15,23,42,0.98),rgba(15,23,42,0.94));
    }

    .library-item:hover {
      border-color: rgba(56,189,248,0.8);
      box-shadow: 0 0 14px rgba(56,189,248,0.55);
      transform: translateY(-1px);
    }

    .library-info-main {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .library-row-top {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .library-type-tag {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.7);
      background: rgba(15,23,42,0.9);
    }

    .tag-image { border-color: rgba(96,165,250,0.8); color: #bfdbfe;}
    .tag-audio { border-color: rgba(52,211,153,0.8); color: #bbf7d0;}
    .tag-video { border-color: rgba(249,115,22,0.8); color: #fed7aa;}

    .library-prompt {
      font-size: 12px;
      color: #e5e7eb;
    }

    .library-meta {
      font-size: 11px;
      color: #9ca3af;
    }

    .library-time {
      font-size: 11px;
      color: #9ca3af;
      white-space: nowrap;
      margin-left: 10px;
    }

    /* ç™»å½•é¡µ */
    .login-page {
      display: flex;
      flex-direction: column;
      height: 100vh;
      background:
        radial-gradient(circle at top,#0f172a 0,#020617 50%,#000 100%),
        linear-gradient(135deg,rgba(56,189,248,0.1),transparent 70%);
      color: #e5e7eb;
    }

    .login-main {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .login-title {
      padding: 16px 26px;
      border-bottom: 1px solid rgba(148,163,184,0.3);
      background: linear-gradient(to right,rgba(15,23,42,0.96),rgba(15,23,42,0.4));
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 20px;
      font-weight: 600;
    }

    .login-title::before {
      content: "";
      width: 12px;
      height: 12px;
      border-radius: 999px;
      background: radial-gradient(circle,#22d3ee 0,#0ea5e9 40%,transparent 100%);
      box-shadow: 0 0 14px rgba(34,211,238,0.9);
      margin-right: 10px;
    }

    .login-sub {
      font-size: 11px;
      color: #9ca3af;
    }

    .login-box {
      width: 420px;
      padding: 26px 30px 28px;
      position: relative;
    }

    .login-box::before {
      content: "";
      position: absolute;
      inset: -2px;
      border-radius: 16px;
      background: conic-gradient(from 140deg,#22d3ee,#0ea5e9,#22d3ee,#164e63);
      opacity: .4;
      filter: blur(8px);
      z-index: -1;
    }

    .login-inner {
      padding: 26px 26px 22px;
    }

    .login-field {
      margin-bottom: 18px;
      display: flex;
      align-items: center;
    }

    .login-label {
      width: 70px;
      font-size: 13px;
      color: #cbd5f5;
    }

    .login-input {
      flex: 1;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid rgba(148,163,184,0.7);
      font-size: 13px;
      background: rgba(15,23,42,0.9);
      color: #e5e7eb;
      outline: none;
    }

    .login-input:focus {
      border-color: #22d3ee;
      box-shadow: 0 0 10px rgba(34,211,238,0.4);
    }

    .btn-login {
      margin-top: 6px;
      width: 100%;
      padding: 10px;
      border-radius: 999px;
      border: 1px solid rgba(56,189,248,0.6);
      background:
        radial-gradient(circle at 20% 0,#22d3ee,#0f766e 60%,#020617 100%);
      color: #ecfeff;
      font-size: 15px;
      cursor: pointer;
      font-weight: 600;
      box-shadow: 0 0 18px rgba(56,189,248,0.7);
    }

    .btn-login:hover {
      transform: translateY(-1px);
      box-shadow: 0 0 26px rgba(56,189,248,0.9);
    }

    .btn-login:active {
      transform: translateY(1px) scale(.98);
      box-shadow: 0 0 14px rgba(56,189,248,0.7);
    }

    .login-error {
      margin-bottom: 14px;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid rgba(248,113,113,0.7);
      background: rgba(248,113,113,0.08);
      color: #fecdd3;
      font-size: 13px;
    }

    .logout-form {
      margin: 0;
    }

    .btn-logout {
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid rgba(248,113,113,0.7);
      background: radial-gradient(circle at 20% 0,rgba(248,113,113,0.25),rgba(15,23,42,0.9));
      color: #fecdd3;
      font-size: 12px;
      cursor: pointer;
    }

    .btn-logout:hover {
      box-shadow: 0 0 10px rgba(248,113,113,0.5);
    }

    .hidden { display: none; }
  </style>
</head>
<body>
{% if not user.is_authenticated %}
<!-- ç™»å½•é¡µé¢ -->
<div id="loginPage" class="login-page">
  <div class="login-title">
    <div>
      å¹¿æ’­ç”µè§†å’Œç½‘ç»œè§†å¬æ™ºèƒ½åª’ä½“å†…å®¹ç”Ÿæˆç³»ç»Ÿ
      <div class="login-sub">Broadcasting & Online AV Intelligent Media Generation System</div>
    </div>
    <div class="header-pill">
      <div class="header-pill-dot"></div>
      <span>å†…ç½‘å·²è¿æ¥</span>
    </div>
  </div>
  <div class="login-main">
    <div class="login-box neon-card">
      <form class="login-inner" method="post" action="">
        {% csrf_token %}
        {% if login_error %}
        <div class="login-error">{{ login_error }}</div>
        {% endif %}
        <div class="login-field">
          <label class="login-label">ç”¨æˆ·åï¼š</label>
          <input id="username" name="username" class="login-input" type="text" value="{{ login_username|default:'' }}" autocomplete="username" required />
        </div>
        <div class="login-field">
          <label class="login-label">å¯†&nbsp;&nbsp;&nbsp;ç ï¼š</label>
          <input id="password" name="password" class="login-input" type="password" autocomplete="current-password" required />
        </div>
        <button class="btn-login" type="submit">ç™»å½•</button>
      </form>
    </div>
  </div>
</div>
{% else %}
<!-- ä¸»ç³»ç»Ÿé¡µé¢ -->
<div id="appPage">
  <div class="app-header">
    <div class="app-title-block">
      <div class="app-title-main">
        å¹¿æ’­ç”µè§†å’Œç½‘ç»œè§†å¬æ™ºèƒ½åª’ä½“å†…å®¹ç”Ÿæˆç³»ç»Ÿ
      </div>
    </div>
    <div class="app-header-right">
      <div class="header-pill">
        <div class="header-pill-dot"></div>
        <span>ç”Ÿæˆå¼•æ“åœ¨çº¿</span>
      </div>
      <div class="user-pill">
        <div class="user-avatar"></div>
        <span>{{ request.user.username }}</span>
      </div>
      <form class="logout-form" method="post" action="{% url 'logout' %}">
        {% csrf_token %}
        <button type="submit" class="btn-logout">é€€å‡º</button>
      </form>
    </div>
  </div>

  <div class="app-container">
    <!-- å·¦ä¾§å¯¼èˆª -->
    <div class="sidebar">
      <div class="sidebar-header">WORKSPACE</div>
      <div class="nav-item active" data-mode="image" onclick="switchMode('image', this)">
        <span class="nav-item-icon">ğŸ–¼</span>
        <span>å›¾åƒç”Ÿæˆ</span>
      </div>
      <div class="nav-item" data-mode="audio" onclick="switchMode('audio', this)">
        <span class="nav-item-icon">ğŸ§</span>
        <span>éŸ³é¢‘ç”Ÿæˆ</span>
      </div>
      <div class="nav-item" data-mode="video" onclick="switchMode('video', this)">
        <span class="nav-item-icon">ğŸ¬</span>
        <span>è§†é¢‘ç”Ÿæˆ</span>
      </div>
      <div class="nav-item nav-item-library" onclick="switchToLibrary(this)">
        <span class="nav-item-icon">ğŸ“š</span>
        <span>ç”Ÿæˆå†…å®¹åº“</span>
      </div>
    </div>

    <!-- å³ä¾§ä¸»ä½“ -->
    <div class="main">
      <!-- ç”Ÿæˆç•Œé¢ -->
      <div id="generationMain">
        <div class="main-top">
          <!-- é¢„è§ˆåŒºåŸŸ -->
          <div class="preview-panel neon-card">
            <div class="preview-panel-header">
              <div class="preview-title">ç”Ÿæˆç»“æœé¢„è§ˆ</div>
              <div class="panel-tag" id="previewModeTag">æ¨¡å¼ï¼šå›¾åƒ</div>
            </div>
            <div class="preview-panel-inner">
              <div class="preview-grid">
                <div id="previewPlaceholder" class="preview-placeholder">
                  <div class="preview-placeholder-title">å›¾ç‰‡ç”Ÿæˆé¢„è§ˆåŒºåŸŸ</div>
                  <div>ç‚¹å‡»å³ä¾§ã€Œç”Ÿæˆã€åï¼Œå°†åœ¨æ­¤æ˜¾ç¤º ./1.jpeg / 2.mp4 / 3.mp3</div>
                </div>

                <div id="loadingBox" class="loading-box">
                  <div class="spinner"></div>
                  <div id="loadingText">æ­£åœ¨ç”Ÿæˆï¼Œè¯·ç¨å€™â€¦</div>
                </div>

                <img id="imageResult" alt="å›¾åƒç»“æœ" />

                <div id="audioPreview">
                  <div class="preview-placeholder-title">éŸ³é¢‘ç”Ÿæˆç»“æœ</div>
                  <audio id="audioPlayer" controls></audio>
                </div>

                <div id="videoPreview">
                  <div class="preview-placeholder-title">è§†é¢‘ç”Ÿæˆç»“æœ</div>
                  <video id="videoPlayer" controls></video>
                </div>
              </div>
            </div>
          </div>

          <!-- å‚æ•°é…ç½® + ç”Ÿæˆ -->
          <div class="control-panel neon-card">
            <div class="control-fields">
              <div class="field">
                <span id="styleLabel" class="field-label">ä¸»é¢˜é£æ ¼ï¼š</span>
                <div class="radio-group" id="styleOptions">
                  <label><input type="radio" name="style" value="åŠ¨ç”»" checked> åŠ¨ç”»</label>
                  <label><input type="radio" name="style" value="å†™å®"> å†™å®</label>
                  <label><input type="radio" name="style" value="æ¼”æ’­å®¤"> æ¼”æ’­å®¤</label>
                  <label><input type="radio" name="style" value="å…¶ä»–"> å…¶ä»–</label>
                </div>

                <div class="radio-group hidden" id="voiceOptions">
                  <label><input type="radio" name="voice" value="ç”·å£°1" checked> ç”·å£°1</label>
                  <label><input type="radio" name="voice" value="ç”·å£°2"> ç”·å£°2</label>
                  <label><input type="radio" name="voice" value="å¥³ç”Ÿ1"> å¥³å£°1</label>
                  <label><input type="radio" name="voice" value="å¥³ç”Ÿ2"> å¥³å£°2</label>
                </div>
              </div>

              <div class="field">
                <span class="field-label">æ¨¡å‹ï¼š</span>
                <select id="modelSelect" class="dropdown">
                  <option value="å¹¿ç§‘é™¢">å¹¿ç§‘é™¢</option>
                  <option value="æµ·èº">æµ·èº</option>
                  <option value="å³æ¢¦">å³æ¢¦</option>
                  <option value="å¯çµ">å¯çµ</option>
                </select>
              </div>

              <div class="field">
                <span class="field-label">å…³é”®è¯ promptï¼š</span>
                <textarea id="promptInput" placeholder="è¯·è¾“å…¥ç”¨äºç”Ÿæˆå†…å®¹çš„å…³é”®è¯ã€åœºæ™¯æè¿°ç­‰â€¦â€¦"></textarea>
              </div>
            </div>

            <div class="generate-panel">
              <button id="generateBtn" class="btn-generate" onclick="handleGenerate()">ç”Ÿæˆ</button>
            </div>
          </div>
        </div>
      </div>

      <!-- ç”Ÿæˆå†…å®¹åº“é¡µé¢ -->
      <div id="libraryMain" class="hidden">
        <div id="libraryPanel" class="library-panel neon-card">
          <div class="library-header">
            <div>
              <div class="library-title">
                <div class="library-title-dot"></div>
                <span>ç”Ÿæˆå†…å®¹åº“</span>
              </div>
              <div id="libraryStats" class="library-stats">æš‚æ— è®°å½•</div>
            </div>
            <div class="library-filters">
              <button class="filter-pill active" data-filter="all" onclick="setLibraryFilter('all', this)">å…¨éƒ¨</button>
              <button class="filter-pill" data-filter="image" onclick="setLibraryFilter('image', this)">å›¾åƒ</button>
              <button class="filter-pill" data-filter="audio" onclick="setLibraryFilter('audio', this)">éŸ³é¢‘</button>
              <button class="filter-pill" data-filter="video" onclick="setLibraryFilter('video', this)">è§†é¢‘</button>
            </div>
          </div>
          <div id="libraryList" class="library-list">
            <div class="library-empty">æš‚æ— ç”Ÿæˆè®°å½•ï¼Œç”Ÿæˆåçš„å›¾åƒã€éŸ³é¢‘ã€è§†é¢‘å°†è‡ªåŠ¨å­˜å…¥æ­¤å¤„ã€‚</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% endif %}

<script>
  let currentMode = "image"; // image | audio | video
  let generating = false;
  let mediaStore = [];
  let currentFilter = "all";
  // åˆ‡æ¢å›¾åƒ/éŸ³é¢‘/è§†é¢‘æ ç›®
  function switchMode(mode, elem) {
    if (generating) return;
    currentMode = mode;

    document.querySelectorAll(".nav-item").forEach(item => item.classList.remove("active"));
    elem.classList.add("active");

    document.getElementById("generationMain").classList.remove("hidden");
    document.getElementById("libraryMain").classList.add("hidden");

    const styleLabel   = document.getElementById("styleLabel");
    const styleOptions = document.getElementById("styleOptions");
    const voiceOptions = document.getElementById("voiceOptions");
    const modelSelect  = document.getElementById("modelSelect");
    const placeholder  = document.getElementById("previewPlaceholder");
    const loadingBox   = document.getElementById("loadingBox");
    const imageResult  = document.getElementById("imageResult");
    const audioPreview = document.getElementById("audioPreview");
    const videoPreview = document.getElementById("videoPreview");
    const modeTag      = document.getElementById("previewModeTag");

    placeholder.style.display  = "block";
    loadingBox.style.display   = "none";
    imageResult.style.display  = "none";
    audioPreview.style.display = "none";
    videoPreview.style.display = "none";

    if (mode === "image") {
      placeholder.querySelector(".preview-placeholder-title").textContent = "å›¾ç‰‡ç”Ÿæˆé¢„è§ˆåŒºåŸŸ";
      styleLabel.textContent = "ä¸»é¢˜é£æ ¼ï¼š";
      styleOptions.classList.remove("hidden");
      voiceOptions.classList.add("hidden");
      modeTag.textContent = "æ¨¡å¼ï¼šå›¾åƒ";
      modeTag.style.borderColor = "rgba(96,165,250,0.8)";
      modeTag.style.color = "#bfdbfe";

      modelSelect.innerHTML = `
        <option value="å¹¿ç§‘é™¢">å¹¿ç§‘é™¢</option>
        <option value="æµ·èº">æµ·èº</option>
        <option value="å³æ¢¦">å³æ¢¦</option>
        <option value="å¯çµ">å¯çµ</option>
      `;
    } else if (mode === "audio") {
      placeholder.querySelector(".preview-placeholder-title").textContent =
        "éŸ³é¢‘ç”ŸæˆåŒºåŸŸï¼ˆå®Œæˆåä¼šæ’­æ”¾ ./3.mp3ï¼‰";
      styleLabel.textContent = "äººç”Ÿé€‰æ‹©ï¼š";
      styleOptions.classList.add("hidden");
      voiceOptions.classList.remove("hidden");
      modeTag.textContent = "æ¨¡å¼ï¼šéŸ³é¢‘";
      modeTag.style.borderColor = "rgba(52,211,153,0.8)";
      modeTag.style.color = "#bbf7d0";

      modelSelect.innerHTML = `
        <option value="å¹¿ç§‘é™¢">å¹¿ç§‘é™¢</option>
        <option value="cosyvoice">cosyvoice</option>
      `;
    } else if (mode === "video") {
      placeholder.querySelector(".preview-placeholder-title").textContent =
        "è§†é¢‘ç”Ÿæˆé¢„è§ˆåŒºåŸŸï¼ˆå®Œæˆåä¼šæ’­æ”¾ ./2.mp4ï¼‰";
      styleLabel.textContent = "ä¸»é¢˜é£æ ¼ï¼š";
      styleOptions.classList.remove("hidden");
      voiceOptions.classList.add("hidden");
      modeTag.textContent = "æ¨¡å¼ï¼šè§†é¢‘";
      modeTag.style.borderColor = "rgba(249,115,22,0.8)";
      modeTag.style.color = "#fed7aa";

      modelSelect.innerHTML = `
        <option value="å¹¿ç§‘é™¢">å¹¿ç§‘é™¢</option>
        <option value="æµ·èº">æµ·èº</option>
        <option value="å³æ¢¦">å³æ¢¦</option>
        <option value="å¯çµ">å¯çµ</option>
      `;
    }
  }

  // åˆ‡æ¢åˆ°ç”Ÿæˆå†…å®¹åº“é¡µ
  function switchToLibrary(elem) {
    if (generating) return;
    document.querySelectorAll(".nav-item").forEach(item => item.classList.remove("active"));
    elem.classList.add("active");

    document.getElementById("generationMain").classList.add("hidden");
    document.getElementById("libraryMain").classList.remove("hidden");
  }

  // ç‚¹å‡»ç”Ÿæˆ
  function handleGenerate() {
    if (generating) return;
    generating = true;

    const prompt = document.getElementById("promptInput").value.trim();
    const model  = document.getElementById("modelSelect").value;

    const placeholder  = document.getElementById("previewPlaceholder");
    const loadingBox   = document.getElementById("loadingBox");
    const loadingText  = document.getElementById("loadingText");
    const imageResult  = document.getElementById("imageResult");
    const audioPreview = document.getElementById("audioPreview");
    const videoPreview = document.getElementById("videoPreview");
    const audioPlayer  = document.getElementById("audioPlayer");
    const videoPlayer  = document.getElementById("videoPlayer");
    const generateBtn  = document.getElementById("generateBtn");

    placeholder.style.display  = "none";
    imageResult.style.display  = "none";
    audioPreview.style.display = "none";
    videoPreview.style.display = "none";
    loadingBox.style.display   = "block";

    let waitMs = 5000;
    let modeName = "å›¾ç‰‡";
    if (currentMode === "audio") {
      waitMs = 10000;
      modeName = "éŸ³é¢‘";
    } else if (currentMode === "video") {
      waitMs = 20000;
      modeName = "è§†é¢‘";
    }

    loadingText.textContent = `æ­£åœ¨ç”Ÿæˆ${modeName}ï¼Œè¯·ç¨å€™â€¦ï¼ˆæ¨¡å‹ï¼š${model}ï¼‰`;
    generateBtn.disabled = true;
    generateBtn.textContent = "ç”Ÿæˆä¸­â€¦";

    setTimeout(() => {
      loadingBox.style.display = "none";

      let filePath = "";
      if (currentMode === "image") {
        filePath = "./1.jpeg";
        imageResult.src = filePath;
        imageResult.style.display = "block";
      } else if (currentMode === "audio") {
        filePath = "./3.mp3";
        audioPlayer.src = filePath;
        audioPreview.style.display = "block";
        audioPlayer.play();
      } else if (currentMode === "video") {
        filePath = "./2.mp4";
        videoPlayer.src = filePath;
        videoPreview.style.display = "block";
        videoPlayer.play();
      }

      addToMediaStore({
        type: currentMode,
        path: filePath,
        model,
        prompt
      });

      generateBtn.disabled = false;
      generateBtn.textContent = "ç”Ÿæˆ";
      generating = false;
    }, waitMs);
  }

  // å­˜å…¥ç”Ÿæˆå†…å®¹åº“
  function addToMediaStore({type, path, model, prompt}) {
    const now = new Date();
    const id = now.getTime();
    const timeStr = now.toLocaleTimeString("zh-CN", {hour12: false});
    const createdAt = now.toISOString();

    let style = "";
    let voice = "";
    if (type === "image" || type === "video") {
      style = document.querySelector("input[name='style']:checked")?.value || "";
    } else if (type === "audio") {
      voice = document.querySelector("input[name='voice']:checked")?.value || "";
    }

    const record = {
      id,
      type,
      path,
      model,
      prompt,
      style,
      voice,
      createdAt,
      time: timeStr
    };

    mediaStore.unshift(record);
    renderLibrary();
  }

  function setLibraryFilter(filter, elem) {
    currentFilter = filter;
    document.querySelectorAll(".filter-pill").forEach(btn => btn.classList.remove("active"));
    elem.classList.add("active");
    renderLibrary();
  }

  function renderLibrary() {
    const listEl = document.getElementById("libraryList");
    const statsEl = document.getElementById("libraryStats");
    listEl.innerHTML = "";

    const filtered = mediaStore.filter(item => {
      if (currentFilter === "all") return true;
      return item.type === currentFilter;
    });

    if (statsEl) {
      statsEl.textContent =
        mediaStore.length === 0
          ? "æš‚æ— è®°å½•"
          : `å…± ${mediaStore.length} æ¡ç”Ÿæˆè®°å½•ï¼Œå½“å‰æ˜¾ç¤º ${filtered.length} æ¡`;
    }

    if (filtered.length === 0) {
      const empty = document.createElement("div");
      empty.className = "library-empty";
      empty.textContent = "å½“å‰ç­›é€‰æ¡ä»¶ä¸‹æš‚æ— ç”Ÿæˆè®°å½•ã€‚";
      listEl.appendChild(empty);
      return;
    }

    filtered.forEach(item => {
      const row = document.createElement("div");
      row.className = "library-item";
      row.onclick = () => previewFromRecord(item);

      const infoMain = document.createElement("div");
      infoMain.className = "library-info-main";

      const topRow = document.createElement("div");
      topRow.className = "library-row-top";

      const typeTag = document.createElement("span");
      typeTag.className = "library-type-tag";
      if (item.type === "image") {
        typeTag.classList.add("tag-image");
        typeTag.textContent = "å›¾åƒ";
      } else if (item.type === "audio") {
        typeTag.classList.add("tag-audio");
        typeTag.textContent = "éŸ³é¢‘";
      } else if (item.type === "video") {
        typeTag.classList.add("tag-video");
        typeTag.textContent = "è§†é¢‘";
      }

      const promptSpan = document.createElement("span");
      promptSpan.className = "library-prompt";
      promptSpan.textContent = item.prompt ? item.prompt : "ï¼ˆæœªå¡«å†™å…³é”®è¯ï¼‰";

      topRow.appendChild(typeTag);
      topRow.appendChild(promptSpan);

      const metaRow = document.createElement("div");
      metaRow.className = "library-meta";
      let detail = `æ¨¡å‹ï¼š${item.model || "-"} Â· æ–‡ä»¶ï¼š${item.path}`;
      if (item.type === "image" || item.type === "video") {
        detail = `æ¨¡å‹ï¼š${item.model || "-"} Â· é£æ ¼ï¼š${item.style || "-"} Â· æ–‡ä»¶ï¼š${item.path}`;
      } else if (item.type === "audio") {
        detail = `æ¨¡å‹ï¼š${item.model || "-"} Â· äººå£°ï¼š${item.voice || "-"} Â· æ–‡ä»¶ï¼š${item.path}`;
      }
      metaRow.textContent = detail;

      infoMain.appendChild(topRow);
      infoMain.appendChild(metaRow);

      const timeSpan = document.createElement("div");
      timeSpan.className = "library-time";
      timeSpan.textContent = item.time;

      row.appendChild(infoMain);
      row.appendChild(timeSpan);

      listEl.appendChild(row);
    });
  }

  // ä»ç”Ÿæˆå†…å®¹åº“ç‚¹å‡»è®°å½•ï¼Œå›æ”¾åˆ°é¢„è§ˆåŒº
  function previewFromRecord(record) {
    if (generating) return;

    const modeMap = { image: "image", audio: "audio", video: "video" };
    const targetMode = modeMap[record.type];
    if (targetMode) {
      const nav = document.querySelector(`.nav-item[data-mode="${targetMode}"]`);
      if (nav) switchMode(targetMode, nav);
    }

    const placeholder  = document.getElementById("previewPlaceholder");
    const loadingBox   = document.getElementById("loadingBox");
    const imageResult  = document.getElementById("imageResult");
    const audioPreview = document.getElementById("audioPreview");
    const videoPreview = document.getElementById("videoPreview");
    const audioPlayer  = document.getElementById("audioPlayer");
    const videoPlayer  = document.getElementById("videoPlayer");

    placeholder.style.display  = "none";
    loadingBox.style.display   = "none";
    imageResult.style.display  = "none";
    audioPreview.style.display = "none";
    videoPreview.style.display = "none";

    if (record.type === "image") {
      imageResult.src = record.path;
      imageResult.style.display = "block";
    } else if (record.type === "audio") {
      audioPlayer.src = record.path;
      audioPreview.style.display = "block";
      audioPlayer.play();
    } else if (record.type === "video") {
      videoPlayer.src = record.path;
      videoPreview.style.display = "block";
      videoPlayer.play();
    }
  }
</script>
</body>
</html>
